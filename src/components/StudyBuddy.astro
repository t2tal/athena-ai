---
// src/components/StudyBuddy.astro
---

<div id="p5-container"></div>

<div class="ui-overlay">
  <h1>Study Session</h1>
  
  <div class="character-select">
    <button id="btn-girl" class="avatar-btn active" style="--highlight: #8b5cf6;">♀ Athena</button>
    <button id="btn-boy" class="avatar-btn" style="--highlight: #06b6d4;">♂ Atlas</button>
  </div>

  <div class="main-controls">
    <button id="talkBtn" class="mic-btn">Click to Speak</button>
  </div>

  <div id="status" class="status-text"><em>System Ready...</em></div>
</div>

<script>
  // @ts-nocheck
  import { io } from "socket.io-client";
  import p5 from "p5"; 

  const socket = io("http://localhost:5001"); 
  const statusDiv = document.getElementById('status');

  // --- p5 wave sketch (UPDATED PALETTE) ---
  const sketch = (p) => {
    let time = 0;
    let speed = 0.005;        
    let targetSpeed = 0.005;

    let amplitude = 30;
    let targetAmplitude = 30;

    // NEW PALETTE: Violets, Indigos, and Cyan (Dark Mode Friendly)
    const palette = [
        { r: 139, g: 92,  b: 246 }, // Violet (#8b5cf6)
        { r: 124, g: 58,  b: 237 }, // Deep Purple
        { r: 6,   g: 182, b: 212 }, // Cyan (#06b6d4)
        { r: 46,  g: 16,  b: 101 }, // Dark Indigo
        { r: 13,  g: 13,  b: 18  }  // Dark Background (#0d0d12)
    ];
    
    p.setup = () => {
      const canvas = p.createCanvas(p.windowWidth, p.windowHeight);
      canvas.parent("p5-container");
      p.noFill();
      p.strokeWeight(3);
      p.strokeJoin(p.ROUND);
    };

    p.windowResized = () => {
      p.resizeCanvas(p.windowWidth, p.windowHeight);
    }

    p.draw = () => {
      // Background matched to CSS --bg-color (#0d0d12) -> RGB(13, 13, 18)
      p.background(13, 13, 18);

      speed = p.lerp(speed, targetSpeed, 0.02);
      amplitude = p.lerp(amplitude, targetAmplitude, 0.02);
      time += speed;
      
      let centerY = p.height / 2 + 50; 

      for (let i = 0; i < palette.length; i++) {
          let col = palette[i];
          p.stroke(col.r, col.g, col.b, 180);
          
          p.beginShape();
          for (let x = 0; x <= p.width; x += 10) { 
             let noiseVal = p.noise(x * 0.002, time - (i * 0.3));
             let y = centerY + p.map(noiseVal, 0, 1, -amplitude * (1+i*0.2), amplitude * (1+i*0.2));
             p.vertex(x, y);
          }
          p.endShape();
      }
    };

    // controls
    p.setTalking = (isTalking) => {
        if (isTalking) {
            targetSpeed = 0.01;
            targetAmplitude = p.height / 3; 
        } else {
            targetSpeed = 0.005;
            targetAmplitude = 30;    
        }
    }
  };

  const myP5 = new p5(sketch);

  const btnGirl = document.getElementById('btn-girl');
  const btnBoy = document.getElementById('btn-boy');

  btnGirl.addEventListener('click', () => {
    btnGirl.classList.add('active'); btnBoy.classList.remove('active');
    socket.emit('change_voice', { character: 'girl' });
    statusDiv.innerText = "Selected: Athena";
  });
  btnBoy.addEventListener('click', () => {
    btnBoy.classList.add('active'); btnGirl.classList.remove('active');
    socket.emit('change_voice', { character: 'boy' });
    statusDiv.innerText = "Selected: Atlas";
  });

  // speech
  const talkBtn = document.getElementById('talkBtn');
  const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new Recognition();
  recognition.lang = 'en-US';
  recognition.interimResults = false;

  talkBtn.addEventListener('click', () => {
    statusDiv.innerText = "Listening...";
    statusDiv.style.color = "#8b5cf6"; // Violet text
    recognition.start();
  });

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    statusDiv.innerText = `You: "${transcript}"`;
    statusDiv.style.color = "#e0e0e0";
    socket.emit('user_message', { message: transcript });
  };

  socket.on('ai_response', (data) => {
    statusDiv.innerText = `AI: "${data.text}"`;
    if (data.audio) {
        const audio = new Audio(data.audio);
        myP5.setTalking(true); 
        audio.play();
        audio.onended = () => {
            myP5.setTalking(false);
        };
    }
  });
</script>

<style>
  #p5-container {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: -1;
    background-color: #0d0d12; /* Updated Dark BG */
  }

  /* ui layout */
  .ui-overlay {
    position: relative;
    text-align: center;
    padding-top: 15vh;
    padding-left: 20px;
    padding-right: 20px;
    color: #e0e0e0; 
    max-width: 700px;
    margin: 0 auto;
    font-family: 'Inter', sans-serif;
  }
  
  h1 { 
      font-weight: 800; 
      font-size: 3.5rem; 
      letter-spacing: -2px; 
      margin-bottom: 80px;
      /* Violet Glow Shadow */
      text-shadow: 0 0 40px rgba(139, 92, 246, 0.4);
  }

  .character-select { margin-bottom: 60px; } 
  
  .avatars { display: flex; justify-content: center; gap: 30px; }
  
  .avatar-btn {
    background: rgba(255, 255, 255, 0.05); 
    color: #aaa;
    border: 1px solid rgba(255,255,255,0.1);
    padding: 15px 40px;
    border-radius: 50px; 
    cursor: pointer; 
    transition: all 0.3s ease;
    font-size: 1.1rem;
    backdrop-filter: blur(10px);
  }
  
  .avatar-btn.active { 
      background: var(--highlight);
      color: white;
      border-color: var(--highlight);
      transform: scale(1.05);
      box-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
  }

  .main-controls { margin-bottom: 60px; } 

  .mic-btn {
    /* Violet Gradient */
    background: linear-gradient(135deg, #8b5cf6 0%, #4c1d95 100%);
    color: white; border: none;
    padding: 25px 80px; border-radius: 60px;
    font-size: 1.5rem; cursor: pointer; 
    font-weight: 600;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    transition: all 0.2s;
    letter-spacing: 0.5px;
  }
  
  .mic-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 25px 60px rgba(139, 92, 246, 0.3);
  }
  
  .mic-btn:active { transform: scale(0.96); }
  
  .status-text { 
      font-size: 1.4rem;
      line-height: 1.6;
      font-weight: 400;
      color: #888;
      min-height: 3rem;
      max-width: 600px;
      margin: 0 auto;
  }
</style>